// prisma/schema.prisma â€” shared at root (monorepo)
// Generates clients for both frontend and backend workspaces.

generator client {
  provider = "prisma-client-js"
  output   = "../frontend/lib/generated/prisma"
}

generator backendClient {
  provider = "prisma-client-js"
  output   = "../backend/src/generated/prisma"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

enum Category {
  RESEARCH
  SEMINAR
  PROJECT
  ANALYSIS
}

enum AcademicLevel {
  UNDERGRADUATE
  GRADUATE
  POSTGRADUATE
  PHD
  PROFESSOR
  RESEARCHER
  OTHER
}

enum NotificationType {
  COMMENT
  LIKE
  UPLOAD
  MESSAGE
  SYSTEM
}

model User {
  id                String         @id @default(auto()) @map("_id") @db.ObjectId
  name              String?
  email             String         @unique
  image             String?
  password          String?
  emailVerified     DateTime?
  verificationCode  String?
  codeExpiry        DateTime?
  lastCodeRequestAt DateTime?
  Profile           Profile[]
  Document          Document[]
  conversationsA    Conversation[] @relation("participantA")
  conversationsB    Conversation[] @relation("participantB")
  readReceipts      ReadReceipt[]
  notifications     Notification[]
  likes             Like[]
  comments          Comment[]
  saves             Save[]
  downloadRecords   DownloadRecord[]
}

model Profile {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  bio       Bio
  user      User     @relation(fields: [userId], references: [id])
  userId    String   @db.ObjectId
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

type Bio {
  institution   String
  department    String
  academicLevel AcademicLevel
  aboutMe       String
  state         String
  country       String
}

model Document {
  id              String           @id @default(auto()) @map("_id") @db.ObjectId
  title           String
  description     String
  category        Category
  institution     String
  year            String
  fileUrl         String
  fileKey         String
  fileName        String
  fileSize        Int
  downloads       Int              @default(0)
  likes           Int              @default(0)
  author          User             @relation(fields: [authorId], references: [id])
  authorId        String           @db.ObjectId
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  likeRecords     Like[]
  commentRecords  Comment[]
  saveRecords     Save[]
  downloadRecords DownloadRecord[]
}

model Notification {
  id         String           @id @default(auto()) @map("_id") @db.ObjectId
  user       User             @relation(fields: [userId], references: [id])
  userId     String           @db.ObjectId
  type       NotificationType
  message    String
  actorId    String?          @db.ObjectId
  documentId String?          @db.ObjectId
  read       Boolean          @default(false)
  createdAt  DateTime         @default(now())

  @@index([userId, createdAt(sort: Desc)])
}

model Like {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  user       User     @relation(fields: [userId], references: [id])
  userId     String   @db.ObjectId
  document   Document @relation(fields: [documentId], references: [id])
  documentId String   @db.ObjectId
  createdAt  DateTime @default(now())

  @@unique([userId, documentId])
}

model Comment {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  content    String
  user       User     @relation(fields: [userId], references: [id])
  userId     String   @db.ObjectId
  document   Document @relation(fields: [documentId], references: [id])
  documentId String   @db.ObjectId
  createdAt  DateTime @default(now())

  @@index([documentId, createdAt(sort: Desc)])
}

model Save {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  user       User     @relation(fields: [userId], references: [id])
  userId     String   @db.ObjectId
  document   Document @relation(fields: [documentId], references: [id])
  documentId String   @db.ObjectId
  createdAt  DateTime @default(now())

  @@unique([userId, documentId])
}

model DownloadRecord {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  user       User     @relation(fields: [userId], references: [id])
  userId     String   @db.ObjectId
  document   Document @relation(fields: [documentId], references: [id])
  documentId String   @db.ObjectId
  createdAt  DateTime @default(now())

  @@index([userId, createdAt(sort: Desc)])
}

model Conversation {
  id             String        @id @default(auto()) @map("_id") @db.ObjectId
  participantA   User          @relation("participantA", fields: [participantAId], references: [id])
  participantAId String        @db.ObjectId
  participantB   User          @relation("participantB", fields: [participantBId], references: [id])
  participantBId String        @db.ObjectId
  createdAt      DateTime      @default(now())
  messages       Message[]
  readReceipts   ReadReceipt[]

  @@unique([participantAId, participantBId])
}

model Message {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  conversation   Conversation @relation(fields: [conversationId], references: [id])
  conversationId String       @db.ObjectId
  senderId       String       @db.ObjectId
  content        String
  createdAt      DateTime     @default(now())

  @@index([conversationId, createdAt(sort: Desc)])
}

model ReadReceipt {
  id                String       @id @default(auto()) @map("_id") @db.ObjectId
  conversation      Conversation @relation(fields: [conversationId], references: [id])
  conversationId    String       @db.ObjectId
  user              User         @relation(fields: [userId], references: [id])
  userId            String       @db.ObjectId
  lastReadMessageId String       @db.ObjectId
  readAt            DateTime     @default(now())

  @@unique([conversationId, userId])
}
